<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Tracker</title>
    <script>
        let editingTransactionId = null; // To keep track of the transaction being edited

        // Fetch and display transactions and summary when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            fetchTransactions();
            fetchSummary(); // Fetch summary data
        });

        // Edit Transaction function
        function editTransaction(id, type, itemName, amount, transactionDate) {
            // Set the editing ID
            editingTransactionId = id;

            // Populate the input fields with the current values
            document.getElementById('type').value = type;
            document.getElementById('itemName').value = itemName;
            document.getElementById('amount').value = parseFloat(amount).toFixed(2);
            document.getElementById('transactionDate').value = transactionDate;

            // Change the button text to "บันทึกข้อมูล" (Save)
            document.getElementById('submit-button').innerText = 'บันทึกข้อมูล'; 

            // Change the onsubmit function to save the edited transaction
            document.getElementById('transaction-form').onsubmit = saveTransaction;
        }

        // Save the edited transaction
        function saveTransaction(event) {
            event.preventDefault();

            const type = document.getElementById('type').value;
            const itemName = document.getElementById('itemName').value;
            const amount = parseFloat(document.getElementById('amount').value).toFixed(2);
            const transactionDate = document.getElementById('transactionDate').value;

            fetch(`http://localhost:3000/transaction/${editingTransactionId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    type: type,
                    itemName: itemName,
                    amount: amount,
                    transactionDate: transactionDate
                })
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                fetchTransactions(); // Refresh the transaction list
                fetchSummary(); // Refresh the summary
                resetForm(); // Reset the form fields
            });
        }

        // Delete Transaction function
        function deleteTransaction(id) {
            if (confirm("คุณแน่ใจหรือว่าต้องการลบรายการนี้?")) {
                fetch(`http://localhost:3000/transaction/${id}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    fetchTransactions(); // Refresh the transaction list
                    fetchSummary(); // Refresh the summary
                });
            }
        }

        // Reset form fields after saving
        function resetForm() {
            document.getElementById('transaction-form').reset();
            editingTransactionId = null; // Clear the editing ID

            // Change button text back to "เพิ่มข้อมูล" (Add)
            document.getElementById('submit-button').innerText = 'เพิ่มข้อมูล'; 

            // Reset form submission
            document.getElementById('transaction-form').onsubmit = addTransaction; // Reset to addTransaction function
        }

        // Add new transaction function
        function addTransaction(event) {
            event.preventDefault();

            const type = document.getElementById('type').value;
            const itemName = document.getElementById('itemName').value;
            const amount = parseFloat(document.getElementById('amount').value).toFixed(2);
            const transactionDate = document.getElementById('transactionDate').value;

            fetch('http://localhost:3000/transaction', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    type: type,
                    itemName: itemName,
                    amount: amount,
                    transactionDate: transactionDate
                })
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                fetchTransactions(); // Refresh the transaction list
                fetchSummary(); // Refresh the summary
                resetForm(); // Reset the form fields
            });
        }

        function fetchTransactions() {
            fetch('http://localhost:3000/transactions')
                .then(response => response.json())
                .then(data => {
                    const transactionList = document.getElementById('transaction-list');
                    transactionList.innerHTML = '';
                    data.transactions.forEach(transaction => {
                        const formattedDate = new Date(transaction.transaction_date).toISOString().split('T')[0]; // Format date to YYYY-MM-DD
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${transaction.type}</td>
                            <td>${transaction.item_name}</td>
                            <td>${transaction.amount}</td>
                            <td>${formattedDate}</td> <!-- Use formatted date here -->
                            <td>
                                <button onclick="editTransaction('${transaction.id}', '${transaction.type}', '${transaction.item_name}', '${transaction.amount}', '${formattedDate}')">แก้ไข</button>
                                <button onclick="deleteTransaction('${transaction.id}')">ลบ</button>
                            </td>
                        `;
                        transactionList.appendChild(row);
                    });
                });
        }

        // Fetch summary data
        function fetchSummary() {
            fetch('http://localhost:3000/transactions') // Assuming this endpoint now returns both transactions and summaries
                .then(response => response.json())
                .then(data => {
                    const summaryTable = document.getElementById('summary-table-body');
                    summaryTable.innerHTML = '';

                    data.summaries.forEach(summary => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${summary.month}</td>
                            <td>${summary.year}</td>
                            <td>${summary.total_income}</td>
                            <td>${summary.total_expenses}</td>
                            <td>${summary.total_balance}</td>
                        `;
                        summaryTable.appendChild(row);
                    });
                });
        }
    </script>
</head>
<body>
    <h1>Expense Tracker</h1>

    <h2>Add New Transaction</h2>
    <form id="transaction-form" onsubmit="addTransaction(event)">
        <label for="type">ประเภท:</label>
        <select id="type" required>
            <option value="รายรับ">รายรับ</option>
            <option value="รายจ่าย">รายจ่าย</option>
        </select>
        <br>

        <label for="itemName">ชื่อรายการ:</label>
        <input type="text" id="itemName" required>
        <br>

        <label for="amount">จำนวนเงิน:</label>
        <input type="number" id="amount" step="0.01" min="0" required>
        <br>

        <label for="transactionDate">วันที่ใช้จ่าย:</label>
        <input type="date" id="transactionDate" required>
        <br>

        <button type="submit" id="submit-button">เพิ่มข้อมูล</button> <!-- Default button text -->
    </form>

    <h2>Transaction List</h2>
    <h2>search</h2>
<label for="filterMonth">เดือน:</label>
<select id="filterMonth" onchange="fetchTransactions(); fetchSummary();">
    <option value="">ทั้งหมด</option>
    <option value="1">มกราคม</option>
    <option value="2">กุมภาพันธ์</option>
    <option value="3">มีนาคม</option>
    <option value="4">เมษายน</option>
    <option value="5">พฤษภาคม</option>
    <option value="6">มิถุนายน</option>
    <option value="7">กรกฎาคม</option>
    <option value="8">สิงหาคม</option>
    <option value="9">กันยายน</option>
    <option value="10">ตุลาคม</option>
    <option value="11">พฤศจิกายน</option>
    <option value="12">ธันวาคม</option>
</select>

<label for="filterYear">ปี:</label>
<select id="filterYear" onchange="fetchTransactions(); fetchSummary();">
    <option value="">ทั้งหมด</option>
    <!-- Populate years dynamically or manually -->
    <option value="2024">2024</option>
    <option value="2023">2023</option>
    <option value="2022">2022</option>
    <!-- Add more years as needed -->
</select>
    <table>
        <thead>
            <tr>
                <th>ประเภท</th>
                <th>ชื่อรายการ</th>
                <th>จำนวนเงิน</th>
                <th>วันที่ใช้จ่าย</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="transaction-list"></tbody>
    </table>

    <h2>Transaction Summary</h2>
    <table>
        <thead>
            <tr>
                <th>เดือน</th>
                <th>ปี</th>
                <th>รายรับรวม</th>
                <th>รายจ่ายรวม</th>
                <th>เงินคงเหลือ</th>
            </tr>
        </thead>
        <tbody id="summary-table-body"></tbody>
    </table>
    
</body>
</html>
